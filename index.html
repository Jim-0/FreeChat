<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Webhook deliveries</title>
  <link rel="shortcut icon" href="https://primer.style/octicons/favicon-32x32.png?v=f3da5bc9ee21801506bcf83c84f79ae4"
    type="image/png">
  <!-- <link href="https://unpkg.com/@primer/css@^16.0.0/dist/primer.css" rel="stylesheet" /> -->
  <link href="./public/primer.css" rel="stylesheet" />
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/Primer/20.0.0/truncate.min.css" rel="stylesheet" /> -->
  <link href="./public/truncate.min.css" rel="stylesheet" />
  <!-- <link href="https://unpkg.com/@github/details-dialog-element/dist/index.css" rel="stylesheet"> -->
  <link href="./public/details-dialog-element.css" rel="stylesheet" />
</head>

<body>

  <div class="Header">
    <div class="Header-item">
      <a href="/" class="Header-link f4 d-flex flex-items-center">
        <!-- <%= octicon "mark-github", class: "mr-2", height: 32 %> -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="mr-1">
          <path fill-rule="evenodd"
            d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.513 11.5h4.745c.1-3.037 1.1-5.49 2.093-7.204.39-.672.78-1.233 1.119-1.673C6.11 3.329 2.746 7 2.513 11.5zm4.77 1.5H2.552a9.505 9.505 0 007.918 8.377 15.698 15.698 0 01-1.119-1.673C8.413 18.085 7.47 15.807 7.283 13zm1.504 0h6.426c-.183 2.48-1.02 4.5-1.862 5.951-.476.82-.95 1.455-1.304 1.88L12 20.89l-.047-.057a13.888 13.888 0 01-1.304-1.88C9.807 17.5 8.969 15.478 8.787 13zm6.454-1.5H8.759c.1-2.708.992-4.904 1.89-6.451.476-.82.95-1.455 1.304-1.88L12 3.11l.047.057c.353.426.828 1.06 1.304 1.88.898 1.548 1.79 3.744 1.89 6.452zm1.476 1.5c-.186 2.807-1.13 5.085-2.068 6.704-.39.672-.78 1.233-1.118 1.673A9.505 9.505 0 0021.447 13h-4.731zm4.77-1.5h-4.745c-.1-3.037-1.1-5.49-2.093-7.204-.39-.672-.78-1.233-1.119-1.673 4.36.706 7.724 4.377 7.957 8.877z">
          </path>
        </svg>
        <span>LinkMeta</span>
      </a>
    </div>
    <!-- Full item stretches across -->
    <div class="Header-item Header-item--full"></div>
    <div class="Header-item position-relative mr-0">
      <details class="details-reset details-overlay details-overlay-dark">
        <summary class="Header-link d-flex flex-items-center">
          <svg aria-hidden="true" height="24" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true"
            class="octicon octicon-three-bars">
            <path fill-rule="evenodd"
              d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
            </path>
          </svg>
        </summary>
        <details-dialog class="Box Box--overlay d-flex flex-column anim-fade-in fast" data-color-mode="auto"
          data-dark-theme="dark" style="min-width: 40%;width: 90%;max-width: 500px;padding: 1px;">
          <div class="Box-header">
            <h3 class="Box-title">About LinkMeta</h3>
          </div>
          <div class="markdown-body">
            <div class="Box-body overflow-auto">
              <p>An implementation of weak central network communication</p>
              <p>Key highlights:</p>
              <ul>
                <li><code>peer-to-peer</code></li>
                <li><code>RSA encryption</code></li>
                <li><code>WebRTC</code></li>
              </ul>
            </div>
          </div>
          <div class="Box-footer">
            <button type="button" class="btn btn-block"
              onclick="(() => {this.parentElement.parentElement.parentElement.open = false;})();">Okay</button>
          </div>
        </details-dialog>
      </details>

    </div>
  </div>

  <div class="position-absolute bottom-0 right-0 left-0 d-flex flex-column" data-color-mode="auto"
    data-dark-theme="dark" style="top: 60px !important;">

    <div class="blankslate blankslate-large">

      <div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
          style="display:inline-block;vertical-align:text-bottom">
          <path fill-rule="evenodd"
            d="M1.75 1A1.75 1.75 0 000 2.75v9.5C0 13.216.784 14 1.75 14H3v1.543a1.457 1.457 0 002.487 1.03L8.061 14h6.189A1.75 1.75 0 0016 12.25v-9.5A1.75 1.75 0 0014.25 1H1.75zM1.5 2.75a.25.25 0 01.25-.25h12.5a.25.25 0 01.25.25v9.5a.25.25 0 01-.25.25h-6.5a.75.75 0 00-.53.22L4.5 15.44v-2.19a.75.75 0 00-.75-.75h-2a.25.25 0 01-.25-.25v-9.5z">
          </path>
          <path
            d="M22.5 8.75a.25.25 0 00-.25-.25h-3.5a.75.75 0 010-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0122.25 20H21v1.543a1.457 1.457 0 01-2.487 1.03L15.939 20H10.75A1.75 1.75 0 019 18.25v-1.465a.75.75 0 011.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 01.53.22l2.72 2.72v-2.19a.75.75 0 01.75-.75h2a.25.25 0 00.25-.25v-9.5z">
          </path>
        </svg>
      </div>
      <h3 class="blankslate-heading">You donâ€™t seem to have any sessions.</h3>

      <p>Start a session to make you communicate with the internet world.</p>
      <div class="anim-fade-in">
        <div class="blankslate-action">
          <button class="btn btn-primary" type="button">Start a random session</button>
        </div>
      </div>

      <p class="mt-3">Alternatively, join a specific session by ID.</p>
      <div class="blankslate-action mt-3">
        <input id="idInput" class="form-control" type="text" placeholder="Session ID" value=""
          aria-label="Sample full responsive width form field">
        <button id="joinButton" class="btn" type="button">Join</button>
      </div>
    </div>

    <div id="pathControl" class="Breadcrumb border-bottom p-1">
      <span class="Truncate">
      </span>
    </div>

    <div id="messageLogScrollView" class="overflow-y-auto" style="flex: auto;width: 100%;">
      <div class="clearfix p-2">
      </div>
    </div>

    <div id="messageEditSpace" class="p-2 border-top" style="display: flex;" data-color-mode="auto"
      data-dark-theme="dark_dimmed">

      <details class="dropdown details-reset details-overlay d-inline-block flex-self-end mb-1 mr-2">
        <summary class="btn btn-sm" style="height: 100%;" aria-haspopup="true">More</summary>

        <ul class="dropdown-menu dropdown-menu-ne">
          <li><a class="dropdown-item" href="#url">Dropdown item</a></li>
        </ul>
      </details>
      <button class="btn btn-sm mr-2" type="button" hidden>Say/Tap</button>
      <textarea class="form-control mr-2" id="example-textarea" style="resize: none;flex: auto;" rows="1"
        placeholder="Message"></textarea>
      <button class="btn btn-sm mr-2 flex-self-end mb-1" type="button" hidden>Emoji</button>
      <button class="btn btn-sm btn-primary flex-self-end mb-1" type="button" aria-disabled="true">Send</button>
    </div>

  </div>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> -->
  <script src="./public/crypto-js.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.2.1/jsencrypt.min.js"></script> -->
  <script src="./public/jsencrypt.min.js"></script>

  <script src="./public/main.js"></script>

</body>

<script>

  const headerHeight = document.querySelector('div.Header').clientHeight;
  console.assert(headerHeight == 60);

  function copy(targetElement) {
    // console.log('copy()', targetElement);
    window.getSelection().selectAllChildren(targetElement);
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

</script>

<script>

  // const frameHTML = '<iframe id="messageLogiframeView" style="width: 100%; border: 0px; border-radius: 6px; height: 150px;" hidden></iframe>'
  // document.querySelector('div.Header').insertAdjacentHTML('afterEnd', frameHTML);
  // const link_primer_CSS_HMTL = '<link href="./public/primer.css" rel="stylesheet" />';
  // const messagesLogiframeView = document.querySelector('iframe#messageLogiframeView');
  // messagesLogiframeView.contentDocument.documentElement.innerHTML = link_primer_CSS_HMTL + document.querySelector('div.blankslate.blankslate-large').outerHTML;
  // messagesLogiframeView.hidden = false;
  // messagesLogiframeView.src = 'https://miniok.herokuapp.com/xFsBYwpDtghHD9nN';
  // messagesLogiframeView.src = 'https://smee.io/xFsBYwpDtghHD9nN';

</script>

<script>

  const messageScrollView = document.querySelector('div#messageLogScrollView');
  const messageInput = document.getElementById('messageEditSpace').querySelector('textarea');
  const pathControl = document.getElementById('pathControl');

</script>

<script>

  function testThroughputPerform() {
    for (str = '', iii = 3772; iii > 0; iii--) {
      str += `${iii % 10} `;
    };
    window.communicationWay.sender.sendMessage(str);
  };

</script>

<script>

  async function testWebRTCAPI() {

    navigator.mediaDevices.getUserMedia({ audio: true, video: true })
      .then(stream => {
        let video = document.querySelector('#rtc');
        video.srcObject = stream;
      })
      .catch(err => {
        console.log(err);
      })

    navigator.mediaDevices.getDisplayMedia()
      .then(stream => {
        let video = document.querySelector('#rtc')
        video.srcObject = stream
      })
      .catch(err => {
        console.log(err)
      })

    // document.querySelector('#rtc').src = ''
    // <video id="rtc" controls="" autoplay="" name="media" loop=""><source src="" type="audio/mpeg"></video>

  }

</script>

<script>

  function testSymmetricEncryption(secretKey) {
    window.communicationWay.encryptor = {
      plainText: null,
      get cipherText() {
        const encrypted = CryptoJS.AES.encrypt(this.plainText, this.secretKey).toString();
        return encrypted;
      }
    };
    window.communicationWay.decryptor = {
      cipherText: null,
      get plainText() {
        var bytes = CryptoJS.AES.decrypt(this.cipherText, this.secretKey);
        const uncrypted = bytes.toString(CryptoJS.enc.Utf8);
        if (bytes.sigBytes < 1) { return 'Mismatch secretKey' };
        return uncrypted;
      }
    };
    window.communicationWay.encryptor.secretKey = secretKey;
    window.communicationWay.decryptor.secretKey = secretKey;
  }

  async function testSubtleCrypto() {
    async function generate_RSA_KeyPair() {
      async function exportCryptoKey(key, format = 'spki') {
        // refer: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/exportKey
        let wrapName = 'Untitled';
        switch (format) {
          case 'spki': wrapName = 'PUBLIC'; break;
          case 'pkcs8': wrapName = 'RSA PRIVATE'; break;
          default: break;
        };
        // !!!: ignore error of `SubtleCrypto.exportKey()`
        const exported = await window.crypto.subtle.exportKey(format, key);
        function ab2str(buf) {
          return String.fromCharCode.apply(null, new Uint8Array(buf));
        };
        const exportedAsString = ab2str(exported);
        const exportedAsBase64 = window.btoa(exportedAsString);
        console.assert(null === exportedAsBase64.match(/[^\x00-\xff]/g), 'Unexpected case\n');
        // !!!: prettify for viewing, not required.
        const formattedContent = exportedAsBase64.replace(/.{64}\x01?/g, "$&\n");
        const pemExported = `-----BEGIN ${wrapName} KEY-----\n${formattedContent}\n-----END ${wrapName} KEY-----`;
        return pemExported;
      };
      // !!!: return null if `SubtleCrypto` is unavailable.
      if (null === (function () { try { window.crypto.subtle.generateKey } catch (err) { return null } })()) { return null }
      const keyPair = await window.crypto.subtle.generateKey(
        {
          name: "RSA-OAEP",
          modulusLength: 2048,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: {
            name: "SHA-512"
          },
        },
        true,
        ["encrypt", "decrypt"]
      );
      // `openssl genrsa -out rsa_2048_priv.pem 2048`
      // `openssl rsa -pubout -in rsa_2048_priv.pem -out rsa_2048_pub.pem`
      const privateKey = await exportCryptoKey(keyPair.privateKey, 'pkcs8');
      const publicKey = await exportCryptoKey(keyPair.publicKey, 'spki');
      const pemKeyPair = { privateKey: privateKey, publicKey: publicKey };
      // console.log('privateKey:', privateKey);
      // console.log('publicKey:', publicKey);
      return pemKeyPair;
    };


    const PRIVATE_KEY = `-----BEGIN RSA PRIVATE KEY-----
  MIICXAIBAAKBgQDdLZ3QnXINC0jOUY/3LxzbIRVURrKu828neC9siTeVR4CsF3by
  QyS43OIZ/6v+bRYKrtk1H4wYEWH6lzu28S9no1Fi8JA0jaDG78+8sFx2rWJgKFv6
  WwCjZq98Au8zKpHE8XHbLnkcXPJK+HLl+Q8tviTkAWGM2U6mRL2pIUapFwIDAQAB
  AoGAOyQbctDm0j4WNbTxffMHEEEEZwiQdt949WDZrXfzeOMpsNqFX7o8c4H8o18O
  KnYY0rp2MhJBb54WSN9vhDdxqRFqz1M6egq1Fc2LVkxhqEO4psjs4VfokxBCGkG9
  bnckqDO02Z/0Xozug2DwuK/jXGNjhdIxAlW+7pP55p/0AUECQQDw6omf3QLilpW6
  2djR3Nd4htOdjq5qVEY5TC0MIYQ6pVzYecWB+5XynDVsO1XgTOosJso5FuIehS07
  O/nquCEPAkEA6wa2wDl1BoCDj4RL4tLDpjTbsorD88z8OQ7Go7bzECIs9PVRnY98
  dmqmAUJZc66CWMlvEjpbKReYMtABse5neQJAR+oK+PB1SwQeX+9lfIfKvgypIJAV
  2mGbsMDfdY6PtR3lkC0RWxKpmQkuHUe9A76R7GoL1WzSRMAGV3c4y+r42wJAYejM
  HUxSakEDjbhJfNbc1tLSa5DPjTNqJ8L2EaHXpHL4U5wXQhJSgWpwebnQVhbvClnw
  QaG59GZ160UoT53H0QJBAI4R7G1C9bAWKDG9YkLlRJGyxtbVaX6tAi4e4v6KZJ+s
  jG12eTgMD8pClcWemCu8I2hFxPFkUAWiXKbkTnKkRmI=
  -----END RSA PRIVATE KEY-----
  `;
    const PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
  MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDdLZ3QnXINC0jOUY/3LxzbIRVU
  RrKu828neC9siTeVR4CsF3byQyS43OIZ/6v+bRYKrtk1H4wYEWH6lzu28S9no1Fi
  8JA0jaDG78+8sFx2rWJgKFv6WwCjZq98Au8zKpHE8XHbLnkcXPJK+HLl+Q8tviTk
  AWGM2U6mRL2pIUapFwIDAQAB
  -----END PUBLIC KEY-----
  `;

    async function testCrypt(pemKeyPair = { privateKey: PRIVATE_KEY, publicKey: PUBLIC_KEY }) {

      console.log('SHA256(pemKeyPair.PRIVATE_KEY)', CryptoJS.SHA256(pemKeyPair.privateKey).toString());

      // `openssl rsa -in PATH_TO_PEM_FILE -pubout -outform DER | openssl sha256 -binary | openssl base64`
      pemKeyPair.id = CryptoJS.MD5(pemKeyPair.publicKey).toString();
      localStorageController.unshiftItem(pemKeyPair, '', 2);
      window.communicationWay.sender.sendMessage(`
  <button class="btn btn-sm" onclick="(() => {
    const publicKey = \`${pemKeyPair.publicKey}\`;
  window.communicationWay.encryptor = {
  plainText: null,
  get cipherText() {
  const encrypt = new JSEncrypt();
  encrypt.setPublicKey(publicKey);
  const encrypted = encrypt.encrypt(this.plainText);
  return encrypted;}}
  const sk = CryptoJS.MD5(\`\${Math.random()}\`).toString();
  window.communicationWay.sender.sendMessage('token '+sk);
  testSymmetricEncryption(sk);
})()"> Apply Key</button>
            `);

      window.communicationWay.encryptor = {
        plainText: null,
        get cipherText() {
          // Encrypt with the public key...
          const encrypt = new JSEncrypt();
          encrypt.setPublicKey(pemKeyPair.publicKey);
          const encrypted = encrypt.encrypt(this.plainText);
          return encrypted;
        }
      }
      window.communicationWay.decryptor = {
        cipherText: null,
        get plainText() {
          // Decrypt with the private key...
          const decrypt = new JSEncrypt();
          decrypt.setPrivateKey(pemKeyPair.privateKey);
          const uncrypted = decrypt.decrypt(this.cipherText);
          if (typeof (uncrypted) == 'string') {
            const tokenMatch = uncrypted.match('token (.*)');
            if (tokenMatch) { testSymmetricEncryption(tokenMatch[1]) }
          };
          return uncrypted;
        }
      }
      const encryptor = window.communicationWay.encryptor;
      const decryptor = window.communicationWay.decryptor;
      const rawText = '123';
      encryptor.plainText = rawText;
      const cipherText = encryptor.cipherText;
      decryptor.cipherText = cipherText;
      const plainText = decryptor.plainText;

      console.log('rawText:', rawText);
      console.log('cipherText:', cipherText);
      console.log('plainText:', plainText);
    };
    // testCrypt();
    testCrypt(await generate_RSA_KeyPair());
  }

</script>

</html>